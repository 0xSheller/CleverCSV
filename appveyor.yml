branches:
  only:
    - appveyor

environment:
  global:
    # CleverCSV requires Python 3.6+
    CIBW_BUILD: cp36-* cp37-*
    # We want to test the wheels that we build
    CIBW_TEST_COMMAND: "python -m unittest discover -f -s {project}/tests/test_unit/"
    # We use a API token for PyPI
    TWINE_USERNAME: __token__

  matrix:
    # Ensure the Python version AppVeyor uses is modern enough
    - PYTHON_VERSION: 3.7

# Does the work
build_script:
  # Extract the git tag manually from the repo
  # This is needed because the variable APPVEYOR_REPO_TAG is not set with 
  # generic git repos
  - ps: $env:GIT_TAG=$(git tag --points-at)
  # Install cibuildwheel
  - pip install cibuildwheel==0.12.0
  # Run cibuildwheel
  - cibuildwheel --output-dir wheelhouse
  # Upload to PyPI if we have a tag set
  - >
    IF NOT "%GIT_TAG%" == ""
    (
    pip install twine
    &&
    python -m twine upload --skip-existing --verbose --repository-url https://test.pypi.org/legacy/ wheelhouse/*.whl
    )
# Make AppVeyor return the artifacts in the web interface
artifacts:
  - path: "wheelhouse\\*.whl"
    name: Wheels
