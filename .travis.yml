# temporarily disable notifications
notifications:
  email: false


# temporarily limit to the travis branch
branches:
  only:
    - travis

secure: "GYIyspsK2uCrS0vGlknn1wbwKIE0JX39uIbCeNJLFiKmmpAF4Mne45IW0+45FKmbK3VotfA2reYmlxxsApPRLQTJPLcunNYrw3jDhjwciO9zBm4uU7CuHiGNQ7w3vk1ORwNzyDv8n82vhhZxmbfPQCHRzeXu9gybIEFk5/PxrTpiEKvrGm9rX3lNoGP5ZFPELdBG84D64qWt5motHGWDysdbJOyfF2UG0lIXJ81hpmPrDQsdoze3nGfrfsACPGwLnjOAcnxHiZxPg6OlGKMKui3tj6o9XJ6BE9JJF49hPFMisQ1XF8skMY7QI68OOEeixPX4kvkIFW0fzV+7NIXY+6kr7Js26eGZdbNNzzRJuyY56DW9kOl3ct5b+l/b0nomqwzDVqRx015Et3DZXTXenHxDZiqxJA8UUyMGmNBXp4vno8Y15shmdz5F8+WovrX2c7aiuwWbQHD/U3e9iuujV4m/RKiIoGg+/X6ETgbVoyw6IDOBhv12zOPc+VwrMauseDPehQgcXYh+Nj+01AaocjbkgmaXdqaiScPXIe6UNSFKov9azxKqEBr/phClOGUaQArbYAE05hvgPYEtwgo8kveJxbomRt+7q+wgYXCE52NEZijMJazhGxpBvRLSil9iBW5RgYXn59vRzD0M8FLibkGiFz5Av7BIsB7EFUcBciQ="

# The matrix defines the platform on which we build the wheels and run the 
# unit tests. Since we use manylinux for the linux wheels, we only need one 
# linux version.
matrix:
  include:
    - language: python
      dist: xenial
      sudo: required
      python: "3.7"
      services:
      - docker

    - os: osx
      osx_image: xcode8.3


env:
  global:
    # Twine username
    - TWINE_USERNAME=__token__

    # CleverCSV is python3.6+
    - CIBW_SKIP="cp27-* cp33-* cp34-* cp35-*"

    # We want to test the wheels that we build
    - CIBW_TEST_COMMAND="python -VV && python -m unittest discover -f -s {project}/tests/test_unit/"

    # Ensure C compiler is set
    - CC="gcc"

    # Use environment variable to make sure we get the right vesion of python 
    # and pip
    - PYTHON=python3
    - PIP=pip3


install:
  # On Mac, ensure we have the latest version of Python (to run cibuildwheel)
  - if [ "${TRAVIS_OS_NAME:-}" == "osx" ]; then
      brew update;
      brew upgrade python;
    fi

  # Install CleverCSV with the test dependencies (extra_requires)
  - $PIP install -e .[tests]

  # Run the unit tests
  - $PYTHON -m unittest discover -v -f -s ./tests/test_unit

  # Remove compiled files (these conflict with cibuildwheel somehow)
  - find . -type f -iname '*.so' -print -delete


script:
  # Use our patched version of cibuildwheel
  - $PIP install -e git+git://github.com/GjjvdBurg/cibuildwheel.git@0c33a585791cf09e56240e7bb7cca21866e8885c#egg=cibuildwheel

  # Run cibuildwheel
  - cibuildwheel --output-dir wheelhouse

  # List the results
  - ls wheelhouse

  # Upload to PyPI if we have a tag
  - |
    if [[ $TRAVIS_TAG ]]; then
      $PIP install twine
      $PYTHON -m twine upload --repository-url https://test.pypi.org/legacy/ wheelhouse/*.whl
    fi
